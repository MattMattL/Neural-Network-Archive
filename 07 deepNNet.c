//	Three-layer (deep) neural networks
//
//	Added arrays for one extra depth, e.g. weightL3[][], delta3[].
//	Has separate functions for feed forward and back prop for an easy use.
//

#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <time.h>

#define NUM_IN 16
#define NUM_MID_L1 16
#define NUM_MID_L2 16
#define NUM_OUT 16

#define NUM_SAMPLE 128
#define MAX_VECTOR 10

float weightL1[NUM_IN][NUM_MID_L1];
float weightL2[NUM_MID_L1][NUM_MID_L2];
float weightL3[NUM_MID_L2][NUM_OUT];

int netIn[NUM_SAMPLE][NUM_IN]
	= {{0,1,0,0,0,1,0,0,1,0,1,1,0,1,0,0}, {0,1,1,0,0,1,1,0,0,0,1,1,1,1,0,0}, {1,0,0,0,0,0,0,0,1,1,1,0,0,1,1,1}, {1,1,0,1,1,1,0,1,0,1,1,1,1,0,0,0}, {0,1,0,0,1,0,0,0,0,1,1,0,1,1,1,0}, {1,0,1,0,1,0,0,1,0,1,1,0,0,0,1,0}, {1,1,0,0,0,1,0,1,1,1,0,1,0,1,0,1}, {1,0,0,0,1,0,0,1,1,0,0,0,1,0,1,1}, {1,1,0,0,1,0,0,1,1,1,0,1,1,1,0,0}, {0,0,0,1,0,1,0,0,0,1,1,1,1,1,0,1}, {1,1,1,0,1,0,0,0,1,0,0,1,0,0,0,0}, {0,0,0,1,0,0,1,1,1,0,1,0,1,1,1,1}, {0,0,0,0,0,1,0,1,0,1,0,1,1,1,0,0}, {1,1,1,1,0,1,1,0,0,0,1,0,0,1,1,1}, {0,1,1,1,0,0,0,0,0,1,0,1,0,0,0,1}, {0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,1}, {0,0,0,1,0,1,0,1,0,1,0,0,1,0,0,1}, {0,1,1,1,1,0,1,0,1,1,1,0,0,0,0,1}, {0,1,0,0,0,1,1,1,1,1,1,1,0,0,0,1}, {0,1,0,1,0,1,0,1,1,0,0,0,0,1,0,0}, {1,0,1,0,1,0,0,0,0,1,1,1,0,0,0,1}, {1,0,1,1,0,1,0,1,1,1,1,0,0,1,0,0}, {0,1,1,0,0,1,1,1,1,0,1,1,0,1,0,1}, {1,0,1,0,1,1,1,0,1,0,1,1,0,1,0,0}, {1,0,1,0,1,1,1,0,0,1,0,0,1,0,0,0}, {0,1,0,0,0,1,0,0,0,0,0,0,0,0,1,1}, {1,1,0,1,0,0,0,1,1,1,1,0,1,0,1,0}, {0,0,1,0,1,1,1,0,1,1,1,0,0,1,0,1}, {1,1,1,0,0,0,0,0,0,0,1,0,1,1,1,0}, {1,1,1,0,1,0,0,1,1,0,1,1,1,1,1,1}, {0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1}, {0,1,0,1,0,0,0,1,1,1,1,1,1,1,0,1}, {0,1,0,1,1,0,0,1,0,0,1,0,0,0,1,1}, {1,0,1,0,0,1,0,1,1,1,1,1,1,1,1,1}, {1,0,1,1,0,0,0,0,0,1,0,1,1,1,0,1}, {1,1,1,0,1,0,0,0,1,1,0,0,1,1,0,0}, {1,0,0,1,0,0,0,0,0,0,0,1,1,1,0,1}, {0,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0}, {1,1,0,1,0,0,1,1,0,0,0,0,1,1,1,1}, {0,0,0,0,1,0,0,0,0,1,1,0,0,0,1,0}, {1,0,0,0,0,0,1,0,0,1,0,0,0,0,1,0}, {0,1,0,1,0,1,0,1,1,1,0,0,0,1,1,1}, {1,1,0,0,0,0,1,0,0,1,1,1,1,0,1,1}, {0,0,1,0,0,1,0,0,1,1,0,1,1,1,1,0}, {1,1,1,1,1,1,1,1,1,0,1,0,0,0,1,1}, {1,0,0,0,1,1,0,0,1,1,1,1,1,0,0,1}, {0,1,0,0,0,1,1,1,0,0,1,0,1,1,1,1}, {1,0,1,0,0,1,1,0,0,0,1,0,1,0,1,0}, {0,1,0,0,1,0,1,0,1,1,1,1,1,0,1,1}, {0,1,1,1,1,0,1,1,1,0,0,1,0,0,0,0}, {1,1,0,1,0,0,1,0,1,0,1,0,0,0,1,0}, {0,1,0,1,1,0,1,1,0,1,1,0,0,0,1,1}, {1,0,1,1,0,1,1,1,1,1,0,0,0,1,0,1}, {0,0,0,1,1,0,1,0,0,0,1,1,1,1,0,0}, {0,1,0,1,0,1,0,0,0,1,0,1,1,0,1,1}, {0,1,1,1,0,1,0,1,0,1,1,0,0,0,1,0}, {1,0,0,0,1,0,0,0,0,1,1,1,0,1,0,0}, {0,0,0,1,0,1,0,1,1,1,0,0,0,1,1,0}, {1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1}, {0,0,1,0,1,1,0,1,1,0,1,0,1,1,0,0}, {0,1,1,1,1,1,1,0,0,0,0,1,0,1,1,1}, {1,0,1,1,1,0,0,0,1,1,1,1,0,0,1,1}, {1,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0}, {1,1,0,1,1,1,1,0,0,0,1,1,0,1,1,0}, {0,1,1,1,0,1,0,1,1,0,1,0,1,1,1,1}, {0,0,0,0,0,1,1,0,1,0,0,0,0,1,0,1}, {1,1,0,1,0,1,1,1,0,1,0,0,1,1,1,1}, {1,0,1,1,0,1,1,0,1,1,1,1,0,0,0,1}, {1,1,1,0,1,0,0,0,1,1,0,0,0,0,1,1}, {0,0,0,0,1,0,1,1,1,0,0,1,0,1,0,1}, {0,1,1,1,0,1,0,1,0,0,0,0,0,0,1,0}, {0,1,0,0,0,0,1,1,0,0,0,0,0,0,1,1}, {1,1,0,0,0,0,0,1,1,1,0,0,0,0,1,0}, {0,1,0,1,1,0,0,0,0,1,1,0,1,0,0,0}, {1,1,1,0,1,0,0,1,1,0,1,0,0,1,1,1}, {0,1,1,1,0,0,0,0,1,1,1,1,0,0,1,0}, {0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,1}, {0,0,1,1,0,0,1,1,1,1,0,1,1,1,1,0}, {1,0,0,0,1,1,1,0,1,1,0,0,0,1,1,0}, {0,1,0,0,1,1,0,0,1,1,0,0,0,1,1,1}, {1,0,1,0,1,0,1,1,0,0,0,1,1,0,0,0}, {1,1,0,0,0,1,1,0,0,0,0,1,1,1,0,0}, {1,0,0,0,1,0,1,0,1,1,1,0,1,0,1,0}, {1,1,1,0,0,0,1,0,1,1,0,0,0,0,1,0}, {1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,1}, {0,0,1,1,0,0,1,0,0,1,1,1,0,0,0,1}, {1,0,1,0,0,1,1,1,0,0,1,1,0,0,0,0}, {0,1,1,0,1,0,0,1,1,1,0,0,1,0,0,1}, {1,0,0,0,1,1,1,1,1,1,0,1,0,0,0,1}, {1,0,0,1,0,1,1,0,0,0,1,0,0,1,1,1}, {0,0,0,0,1,0,1,1,0,1,1,1,0,1,0,0}, {0,1,0,0,0,1,0,0,0,0,1,1,1,1,1,0}, {0,1,1,0,1,1,0,0,1,1,0,1,1,0,1,0}, {0,1,0,1,0,1,0,1,1,0,0,0,1,0,0,0}, {0,1,0,0,1,1,0,0,0,1,1,1,0,0,1,0}, {1,1,1,0,0,0,0,1,1,1,0,1,1,0,1,1}, {1,0,0,0,1,1,1,0,1,1,0,1,0,1,0,0}, {1,1,0,0,1,1,0,1,1,0,1,0,0,0,1,1}, {0,1,1,1,0,0,1,0,0,1,0,1,1,1,0,1}, {0,1,1,0,0,0,1,1,0,1,1,1,0,1,0,0}, {0,0,1,1,1,0,1,0,1,1,0,0,1,1,0,0}, {0,0,0,1,1,1,0,1,1,1,1,1,0,0,0,0}, {1,1,0,0,1,0,0,0,0,0,1,1,1,1,1,1}, {0,1,1,1,0,1,1,1,0,0,1,0,0,0,1,0}, {0,0,0,1,1,1,1,1,0,0,1,1,0,1,1,1}, {0,0,0,1,1,0,1,0,1,1,0,0,1,1,1,1}, {0,1,1,0,0,0,0,0,1,0,1,1,0,0,0,0}, {1,0,1,1,1,1,0,1,1,0,1,1,1,0,0,1}, {1,1,0,0,1,1,0,0,0,1,1,0,1,0,0,0}, {0,1,1,1,1,0,0,0,1,0,1,1,0,0,1,0}, {1,1,0,1,0,1,1,1,0,0,0,1,1,1,1,1}, {0,0,1,0,1,0,1,0,1,1,1,0,1,1,0,1}, {1,0,1,0,0,1,1,1,1,0,1,0,1,0,0,0}, {0,1,0,1,0,1,0,1,0,1,0,0,1,1,0,0}, {0,1,0,0,0,1,1,0,0,0,1,0,0,0,0,1}, {0,1,0,1,0,0,1,1,1,1,1,1,0,1,1,1}, {1,0,1,1,1,1,0,1,0,1,1,0,0,1,0,0}, {0,1,1,0,0,0,1,0,0,1,1,1,1,0,0,1}, {0,1,0,1,0,1,0,1,1,1,1,0,1,0,0,1}, {1,1,0,0,1,0,0,0,0,0,1,0,1,0,0,0}, {0,0,1,1,0,1,1,0,0,1,0,0,1,0,0,1}, {0,0,0,1,1,0,0,1,0,1,1,1,1,0,0,0}, {1,1,0,0,1,1,0,0,1,1,1,1,1,1,1,1}, {0,1,1,0,0,0,0,0,1,0,1,0,1,0,0,0}, {1,1,1,0,1,1,0,0,1,1,0,1,0,1,1,0}, {0,0,1,1,1,0,0,0,0,1,0,0,1,0,0,1}, {0,0,1,0,0,1,1,0,1,0,0,0,0,0,1,1}, {1,0,0,1,1,1,1,0,1,0,1,0,1,0,0,1}};

int desiredOut[NUM_SAMPLE][NUM_OUT]
	= {{0,0,0,0,1,0,1,1,1,1,1,0,0,0,0,1}, {1,1,0,0,0,0,1,0,1,1,0,0,0,0,0,0}, {0,0,1,0,1,0,1,0,0,1,1,1,1,1,1,0}, {1,0,1,0,1,0,1,1,1,1,0,1,1,0,1,1}, {0,1,0,1,0,0,1,1,1,0,0,1,0,1,1,1}, {0,1,0,1,0,1,0,1,1,0,1,0,0,0,1,0}, {0,1,0,1,0,1,1,0,0,0,1,0,1,1,1,1}, {1,0,1,0,0,1,0,0,0,0,1,1,1,1,1,1}, {0,0,1,1,0,0,1,1,1,0,1,1,1,0,0,1}, {1,1,0,1,0,0,0,0,0,0,1,1,1,0,1,0}, {1,1,1,1,0,0,0,0,1,0,1,1,1,0,1,1}, {1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,0}, {0,1,0,0,0,1,0,1,0,1,1,0,1,0,0,1}, {0,0,0,0,0,0,0,1,1,0,0,0,1,1,1,0}, {0,0,1,1,1,1,1,0,1,0,0,1,1,1,1,0}, {0,1,0,1,1,0,0,0,0,0,0,1,1,0,1,1}, {1,1,0,1,0,1,1,0,0,1,1,1,0,1,0,0}, {0,1,1,1,1,1,1,0,1,1,1,0,1,1,1,0}, {1,1,0,0,1,0,0,0,0,1,1,1,0,0,1,1}, {1,0,0,0,0,0,1,1,1,0,0,1,1,1,1,1}, {0,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0}, {0,1,0,0,0,0,1,1,1,0,0,1,1,1,0,1}, {1,0,0,1,1,1,1,0,1,0,1,0,1,0,0,1}, {1,0,0,0,1,1,0,0,1,0,0,0,1,0,1,0}, {0,0,1,1,0,1,0,1,1,1,0,1,0,0,1,0}, {0,1,0,0,0,1,1,0,0,0,1,1,1,1,0,1}, {1,0,0,0,0,0,1,0,1,0,0,0,1,0,1,0}, {0,1,0,1,0,0,0,0,0,0,1,0,0,1,0,1}, {1,1,0,1,0,1,1,0,1,1,1,0,1,0,1,1}, {1,1,0,1,0,0,0,1,1,0,1,1,1,0,1,0}, {1,1,1,1,0,1,0,0,1,0,1,1,0,0,1,1}, {0,0,1,1,0,1,0,0,1,1,0,1,0,1,1,1}, {0,0,0,1,0,1,0,1,1,1,1,1,1,1,0,1}, {0,0,1,0,1,1,1,1,1,0,1,1,0,1,0,0}, {0,0,1,0,1,0,1,1,1,1,0,1,0,0,1,1}, {0,0,1,1,0,1,1,0,0,0,1,0,0,1,1,1}, {1,1,1,1,1,0,1,0,1,1,0,0,1,1,0,0}, {1,1,1,1,1,1,1,0,1,0,0,1,1,1,1,0}, {0,0,1,1,1,1,1,0,1,1,1,0,0,0,0,0}, {0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,0}, {1,1,1,0,1,0,0,0,0,0,1,1,0,1,0,0}, {1,1,0,1,1,0,1,0,1,0,1,1,1,1,0,0}, {0,0,1,0,0,0,1,0,0,0,1,1,0,0,1,0}, {1,1,1,0,0,0,0,0,1,0,0,1,1,0,1,1}, {1,0,0,0,0,1,0,0,1,1,0,0,0,0,1,1}, {1,1,1,0,0,1,0,1,1,0,1,1,0,0,0,0}, {0,0,1,1,1,1,1,1,1,1,0,1,0,1,1,1}, {0,1,0,1,0,1,0,1,0,1,0,1,0,0,0,1}, {0,0,0,0,0,0,0,1,0,1,1,1,1,1,1,0}, {0,1,0,1,1,1,0,1,1,0,0,1,0,0,0,1}, {0,1,0,0,0,0,0,1,0,0,1,0,1,1,1,1}, {1,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0}, {1,0,0,0,1,0,1,1,1,1,1,1,0,1,1,1}, {0,1,0,0,0,0,1,1,0,0,0,0,1,1,0,1}, {1,1,0,0,1,0,1,1,0,1,0,1,1,0,0,1}, {1,0,1,1,0,1,0,1,1,0,0,1,1,1,1,0}, {1,1,0,1,1,0,0,1,1,1,1,1,0,1,1,1}, {0,0,1,0,0,0,0,0,1,1,1,1,0,1,1,1}, {1,1,0,1,1,0,1,1,0,1,1,1,0,0,0,0}, {0,1,1,0,0,0,0,1,1,1,1,0,0,0,1,0}, {0,1,1,0,0,0,1,1,0,1,0,1,0,0,0,0}, {0,0,0,0,1,1,1,0,1,1,0,0,0,0,0,1}, {1,1,0,1,1,0,1,0,0,1,1,0,1,0,1,1}, {1,1,0,0,1,0,1,0,0,1,0,0,0,1,0,1}, {0,1,0,0,0,1,1,1,1,1,1,1,1,1,1,0}, {1,0,1,0,0,0,0,1,1,0,1,0,1,1,1,1}, {1,1,1,1,0,1,0,1,1,1,1,0,1,1,0,1}, {0,0,0,0,0,0,0,1,0,0,1,1,1,1,0,1}, {1,1,0,0,0,1,0,0,0,0,0,1,0,1,0,0}, {1,1,1,1,0,1,0,0,0,0,0,1,0,0,1,1}, {0,0,0,1,1,0,0,0,1,0,1,0,0,1,0,1}, {1,0,0,1,1,1,1,1,1,1,0,1,0,1,1,0}, {1,1,1,1,0,1,1,0,0,0,1,1,0,0,0,1}, {0,0,0,0,1,1,0,0,0,1,0,0,0,1,1,1}, {1,0,1,1,0,1,0,1,1,1,0,0,1,1,1,1}, {1,1,0,0,0,1,0,0,0,0,0,0,1,0,1,1}, {0,1,0,0,1,1,0,0,1,0,1,0,1,0,0,1}, {0,0,0,1,0,0,0,1,0,0,0,1,1,1,1,0}, {1,1,0,1,1,0,0,1,1,0,0,1,0,1,0,1}, {1,1,0,0,0,1,1,0,0,0,0,0,0,1,1,1}, {0,0,1,0,1,0,0,1,1,1,1,1,0,1,0,1}, {1,1,0,1,1,1,1,1,0,0,1,1,0,0,0,0}, {1,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0}, {0,1,1,0,0,1,0,0,1,1,0,0,0,0,0,1}, {1,1,1,1,1,1,1,0,0,0,1,0,1,0,0,1}, {1,0,1,1,1,1,0,1,0,0,0,1,1,1,0,1}, {1,1,0,1,1,1,0,0,1,0,0,0,1,1,0,0}, {0,0,0,0,0,1,0,0,0,0,1,1,1,0,0,0}, {1,0,0,0,1,1,0,1,0,0,1,0,0,0,0,1}, {0,1,1,0,0,0,1,1,0,0,0,0,0,1,1,1}, {1,1,0,0,1,0,0,0,1,0,0,1,1,1,0,1}, {1,1,1,1,0,1,1,1,1,0,0,1,0,0,1,0}, {1,0,0,1,0,1,1,1,0,0,1,0,0,1,1,1}, {0,1,0,0,1,1,1,0,0,1,1,1,1,0,1,1}, {1,0,0,0,1,0,1,1,1,1,0,0,0,1,1,0}, {1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1}, {0,1,1,0,0,0,0,0,0,0,1,1,1,1,0,0}, {1,1,0,1,0,1,1,1,0,0,0,0,0,0,1,1}, {0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,1}, {1,0,0,1,1,1,1,0,0,0,1,0,0,1,1,0}, {0,1,0,1,1,0,0,0,1,1,1,1,1,0,1,1}, {0,1,1,1,1,0,0,1,0,1,1,1,1,1,0,0}, {1,1,1,1,0,1,1,0,0,1,0,0,0,0,0,0}, {1,1,1,1,0,0,1,0,1,0,1,0,1,0,1,1}, {0,1,1,0,0,1,1,1,0,0,1,1,1,1,0,1}, {0,1,1,0,0,0,1,0,0,1,0,0,1,0,1,0}, {0,1,0,1,1,1,0,1,1,1,1,0,0,0,0,1}, {1,0,0,0,0,1,0,1,1,1,1,0,0,0,0,0}, {0,0,1,1,1,0,0,1,0,0,1,1,0,0,0,0}, {0,0,0,0,1,1,0,1,0,1,0,1,0,0,0,0}, {1,1,1,1,0,0,0,0,1,1,0,0,0,1,1,0}, {0,1,0,1,1,1,1,1,0,0,0,0,0,1,1,1}, {0,0,0,0,1,0,1,1,1,1,1,0,0,0,0,0}, {1,1,1,1,0,0,1,1,0,0,1,0,1,1,1,0}, {1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,1}, {0,1,0,0,0,1,0,0,0,1,1,0,0,0,0,0}, {0,1,1,1,1,1,0,0,0,0,0,0,0,1,1,0}, {0,0,1,1,0,0,0,0,0,0,0,0,1,0,1,0}, {1,0,0,0,0,0,0,1,0,1,1,0,0,1,0,0}, {0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0}, {0,0,0,1,1,0,1,1,0,0,0,0,0,1,0,0}, {1,1,1,1,0,1,1,0,0,1,1,1,1,1,0,1}, {1,1,1,0,1,0,0,0,0,1,1,0,1,0,0,0}, {1,0,0,1,1,1,0,0,0,1,0,1,0,0,0,0}, {1,0,1,1,0,0,1,1,0,1,1,1,0,1,1,1}, {0,1,1,1,0,0,1,1,1,0,0,0,0,0,0,1}, {1,1,1,1,0,0,0,0,0,1,1,0,0,0,1,1}, {0,0,0,1,1,0,0,1,0,0,0,1,0,1,1,0}};

float pL1[NUM_MID_L1];
float pL2[NUM_MID_L2];
float pL3[NUM_OUT];

float yL1[NUM_MID_L1];
float yL2[NUM_MID_L2];

float netOut[NUM_OUT];

float delta1[NUM_OUT];
float delta2[NUM_MID_L2];
float delta3[NUM_MID_L1];

int readWeights();
int writeWeights();

void feedForward(int sample);
void backPropagation(int sample);


float sigmoid(float x)
{
	return 1.0/(1 + exp(-x));
}

void barf(char message[])
{
	printf("[error] %s\n", message);
}

float setSingleWeight()
{
	float weight;

	weight = rand() % 200 + 1;
	weight /= 100;
	weight -= 1;

	return weight; // -1.00 ~ 1.00
}

void initialiseWeights(int loadFile)
{
	if(loadFile)
	{
		if(readWeights())
			return;
	}
	else
	{
		int i, j;

		for(i=0; i<NUM_IN; i++)
			for(j=0; j<NUM_MID_L1; j++)
				weightL1[i][j] = setSingleWeight();

		for(i=0; i<NUM_MID_L1; i++)
			for(j=0; j<NUM_MID_L2; j++)
				weightL2[i][j] = setSingleWeight();

		for(i=0; i<NUM_MID_L2; i++)
			for(j=0; j<NUM_OUT; j++)
				weightL3[i][j] = setSingleWeight();
	}
	
}

void scaleWeightVector()
{
	int i, j;

	for(i=0; i<NUM_IN; i++)
	{
		for(j=0; j<NUM_MID_L1; j++)
		{
			if(fabsf(weightL1[i][j]) > MAX_VECTOR)
				weightL1[i][j] = setSingleWeight();
		}
	}

	for(i=0; i<NUM_MID_L1; i++)
	{
		for(j=0; j<NUM_MID_L2; j++)
		{
			if(fabsf(weightL2[i][j]) > MAX_VECTOR)
				weightL2[i][j] = setSingleWeight();
		}
	}

	for(i=0; i<NUM_MID_L2; i++)
	{
		for(j=0; j<NUM_OUT; j++)
		{
			if(fabsf(weightL3[i][j]) > MAX_VECTOR)
				weightL3[i][j] = setSingleWeight();
		}
	}
}

void printWeightInfo()
{
	int i, j;

	for(i=0; i<NUM_IN; i++)
	{
		for(j=0; j<NUM_MID_L1; j++)
			printf("%5.2f ", weightL1[i][j]);
		printf("\n");
	}
	printf("\n");

	for(i=0; i<NUM_MID_L1; i++)
	{
		for(j=0; j<NUM_MID_L2; j++)
			printf("%5.2f ", weightL2[i][j]);
		printf("\n");
	}
	printf("\n");

	for(i=0; i<NUM_MID_L2; i++)
	{
		for(j=0; j<NUM_OUT; j++)
			printf("%5.2f ", weightL3[i][j]);
		printf("\n");
	}
	printf("\n");

	printf("\n");
}

double printNetInfo()
{
	int size_net;

	double diff;
	double sum = 0;

	for(int sample=0; sample<NUM_SAMPLE; sample++)
	{
		printf("[Net]");
		feedForward(sample);

		size_net = (NUM_OUT > NUM_IN)? NUM_OUT : NUM_IN;

		for(int iterate=0; iterate<size_net; iterate++)
		{
			if(iterate < NUM_IN)
				printf("\t%5d", netIn[sample][iterate]);
			else
				printf("\t     ");

			printf("  -->  ");

			if(iterate < NUM_OUT)
				printf("%4.2f (%d)\n", netOut[iterate], desiredOut[sample][iterate]);
			else
				printf("\n");

			if(iterate < NUM_OUT)
			{
				diff = desiredOut[sample][iterate] - netOut[iterate];
				sum += diff * diff;
			}
		}

		printf("\n");
	}

	return sum;
}

void feedForward(int sample)
{
	int i, j, k, l;

	for(j=0; j<NUM_MID_L1; j++)
	{
		pL1[j] = 0;

		for(i=0; i<NUM_IN; i++)
			pL1[j] += netIn[sample][i] * weightL1[i][j];

		yL1[j] = sigmoid(pL1[j]);
	}

	for(k=0; k<NUM_MID_L2; k++)
	{
		pL2[k] = 0;

		for(j=0; j<NUM_MID_L1; j++)
			pL2[k] += yL1[j] * weightL2[j][k];

		yL2[k] = sigmoid(pL2[k]);
	}

	for(l=0; l<NUM_OUT; l++)
	{
		pL3[l] = 0;

		for(int k=0; k<NUM_MID_L2; k++)
			pL3[l] += yL2[k] * weightL3[k][l];

		netOut[l] = sigmoid(pL3[l]);
	}
}

void backPropagation(int sample)
{
	int i, j, k, l;

	for(l=0; l<NUM_OUT; l++)
	{
		delta1[l] = (desiredOut[sample][l] - netOut[l]) * (netOut[l] * (1-netOut[l]));

		for(k=0; k<NUM_MID_L2; k++)
		{
			weightL3[k][l] += delta1[l] * yL2[k];
			delta2[k] = delta1[l] * weightL3[k][l] * (yL2[k] * (1-yL2[k]));

			for(j=0; j<NUM_MID_L1; j++)
			{
				weightL2[j][k] += delta2[k] * yL1[j];
				delta3[j] = delta2[k] * weightL2[j][k] * (yL1[j] * (1-yL1[j]));

				for(i=0; i<NUM_IN; i++)
				{
					weightL1[i][j] += delta3[j] * netIn[sample][i];
				}
			}
		}
	}
}

int main()
{
	int iteration = 10000;
	int loadWeights = 1;

	double totalDiff;

	srand(1010);

	initialiseWeights(loadWeights);
	scaleWeightVector();

	printWeightInfo();
	printNetInfo();

	double runtime = 0;
	runtime = clock();

	for(int round=0; round<iteration/NUM_SAMPLE; round++)
	{
		for(int train=0; train<NUM_SAMPLE; train++)
		{
			feedForward(train);
			backPropagation(train);
		}
	}

	runtime = clock() - runtime;
	runtime /= CLOCKS_PER_SEC;

	printWeightInfo();
	totalDiff = printNetInfo();

	totalDiff /= (NUM_SAMPLE * NUM_OUT);

	printf("total difference: %.8f\n", totalDiff);
	printf("execution time: %.3f s\n\n", runtime);

	writeWeights();
	return 0;

}

const char *location = "./deepWeight.txt";

int readWeights()
{
	FILE *fpRead = fopen(location, "rt");

	// check the location
	if(fpRead == NULL)
	{
		barf("no external file location found");
		exit(1);
	}

	// check the dimension of the network
	int in, mid1, mid2, out, set;

	fscanf(fpRead, "%d %d %d %d %d", &in, &mid1, &mid2, &out, &set);

	if(in!=NUM_IN || mid1!=NUM_MID_L1 || mid2!=NUM_MID_L2 || out!=NUM_OUT || set!=NUM_SAMPLE)
	{
		barf("net size does not match. setting new weights");
		return 0;
	}

	// read from file
	int i, j;

	for(i=0; i<NUM_IN; i++)
		for(j=0; j<NUM_MID_L1; j++)
			fscanf(fpRead, "%f\n", &weightL1[i][j]);

	for(i=0; i<NUM_MID_L1; i++)
		for(j=0; j<NUM_MID_L2; j++)
			fscanf(fpRead, "%f\n", &weightL2[i][j]);

	for(i=0; i<NUM_MID_L2; i++)
		for(j=0; j<NUM_OUT; j++)
			fscanf(fpRead, "%f\n", &weightL3[i][j]);

	return 1;
}

int writeWeights()
{
	FILE *fpWrite = fopen(location, "wt");

	if(fpWrite == NULL)
	{
		barf("fail to generate a new save file");
		return 0;
	}

	fprintf(fpWrite, "%d %d %d %d %d\n", NUM_IN, NUM_MID_L1, NUM_MID_L2, NUM_OUT, NUM_SAMPLE);

	int i, j;

	for(i=0; i<NUM_IN; i++)
		for(j=0; j<NUM_MID_L1; j++)
			fprintf(fpWrite, "%10.4f\n", weightL1[i][j]);

	for(i=0; i<NUM_MID_L1; i++)
		for(j=0; j<NUM_MID_L2; j++)
			fprintf(fpWrite, "%10.4f\n", weightL2[i][j]);

	for(i=0; i<NUM_MID_L2; i++)
		for(j=0; j<NUM_OUT; j++)
			fprintf(fpWrite, "%10.4f\n", weightL3[i][j]);

	return 1;
}
