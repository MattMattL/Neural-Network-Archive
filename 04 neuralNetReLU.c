//	Testing rectified linear unit (ReLU)
//
//	ReLU and the corresponding derivative were added to test activation
//	functions with no upper bound. Training wasn't successful so the
//	later versions use the sigmoid function.
//

#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <time.h>

#define NUM_IN 16
#define NUM_MID 16
#define NUM_OUT 16
#define NUM_SAMPLE 128

#define ReLU_TANGENT 1

float weightL1[NUM_IN][NUM_MID];
float weightL2[NUM_MID][NUM_OUT];

int x[NUM_SAMPLE][NUM_IN]
	 = {{0,1,0,0,0,1,0,0,1,0,1,1,0,1,0,0}, {0,1,1,0,0,1,1,0,0,0,1,1,1,1,0,0}, {1,0,0,0,0,0,0,0,1,1,1,0,0,1,1,1}, {1,1,0,1,1,1,0,1,0,1,1,1,1,0,0,0}, {0,1,0,0,1,0,0,0,0,1,1,0,1,1,1,0}, {1,0,1,0,1,0,0,1,0,1,1,0,0,0,1,0}, {1,1,0,0,0,1,0,1,1,1,0,1,0,1,0,1}, {1,0,0,0,1,0,0,1,1,0,0,0,1,0,1,1}, {1,1,0,0,1,0,0,1,1,1,0,1,1,1,0,0}, {0,0,0,1,0,1,0,0,0,1,1,1,1,1,0,1}, {1,1,1,0,1,0,0,0,1,0,0,1,0,0,0,0}, {0,0,0,1,0,0,1,1,1,0,1,0,1,1,1,1}, {0,0,0,0,0,1,0,1,0,1,0,1,1,1,0,0}, {1,1,1,1,0,1,1,0,0,0,1,0,0,1,1,1}, {0,1,1,1,0,0,0,0,0,1,0,1,0,0,0,1}, {0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,1}, {0,0,0,1,0,1,0,1,0,1,0,0,1,0,0,1}, {0,1,1,1,1,0,1,0,1,1,1,0,0,0,0,1}, {0,1,0,0,0,1,1,1,1,1,1,1,0,0,0,1}, {0,1,0,1,0,1,0,1,1,0,0,0,0,1,0,0}, {1,0,1,0,1,0,0,0,0,1,1,1,0,0,0,1}, {1,0,1,1,0,1,0,1,1,1,1,0,0,1,0,0}, {0,1,1,0,0,1,1,1,1,0,1,1,0,1,0,1}, {1,0,1,0,1,1,1,0,1,0,1,1,0,1,0,0}, {1,0,1,0,1,1,1,0,0,1,0,0,1,0,0,0}, {0,1,0,0,0,1,0,0,0,0,0,0,0,0,1,1}, {1,1,0,1,0,0,0,1,1,1,1,0,1,0,1,0}, {0,0,1,0,1,1,1,0,1,1,1,0,0,1,0,1}, {1,1,1,0,0,0,0,0,0,0,1,0,1,1,1,0}, {1,1,1,0,1,0,0,1,1,0,1,1,1,1,1,1}, {0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1}, {0,1,0,1,0,0,0,1,1,1,1,1,1,1,0,1}, {0,1,0,1,1,0,0,1,0,0,1,0,0,0,1,1}, {1,0,1,0,0,1,0,1,1,1,1,1,1,1,1,1}, {1,0,1,1,0,0,0,0,0,1,0,1,1,1,0,1}, {1,1,1,0,1,0,0,0,1,1,0,0,1,1,0,0}, {1,0,0,1,0,0,0,0,0,0,0,1,1,1,0,1}, {0,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0}, {1,1,0,1,0,0,1,1,0,0,0,0,1,1,1,1}, {0,0,0,0,1,0,0,0,0,1,1,0,0,0,1,0}, {1,0,0,0,0,0,1,0,0,1,0,0,0,0,1,0}, {0,1,0,1,0,1,0,1,1,1,0,0,0,1,1,1}, {1,1,0,0,0,0,1,0,0,1,1,1,1,0,1,1}, {0,0,1,0,0,1,0,0,1,1,0,1,1,1,1,0}, {1,1,1,1,1,1,1,1,1,0,1,0,0,0,1,1}, {1,0,0,0,1,1,0,0,1,1,1,1,1,0,0,1}, {0,1,0,0,0,1,1,1,0,0,1,0,1,1,1,1}, {1,0,1,0,0,1,1,0,0,0,1,0,1,0,1,0}, {0,1,0,0,1,0,1,0,1,1,1,1,1,0,1,1}, {0,1,1,1,1,0,1,1,1,0,0,1,0,0,0,0}, {1,1,0,1,0,0,1,0,1,0,1,0,0,0,1,0}, {0,1,0,1,1,0,1,1,0,1,1,0,0,0,1,1}, {1,0,1,1,0,1,1,1,1,1,0,0,0,1,0,1}, {0,0,0,1,1,0,1,0,0,0,1,1,1,1,0,0}, {0,1,0,1,0,1,0,0,0,1,0,1,1,0,1,1}, {0,1,1,1,0,1,0,1,0,1,1,0,0,0,1,0}, {1,0,0,0,1,0,0,0,0,1,1,1,0,1,0,0}, {0,0,0,1,0,1,0,1,1,1,0,0,0,1,1,0}, {1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1}, {0,0,1,0,1,1,0,1,1,0,1,0,1,1,0,0}, {0,1,1,1,1,1,1,0,0,0,0,1,0,1,1,1}, {1,0,1,1,1,0,0,0,1,1,1,1,0,0,1,1}, {1,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0}, {1,1,0,1,1,1,1,0,0,0,1,1,0,1,1,0}, {0,1,1,1,0,1,0,1,1,0,1,0,1,1,1,1}, {0,0,0,0,0,1,1,0,1,0,0,0,0,1,0,1}, {1,1,0,1,0,1,1,1,0,1,0,0,1,1,1,1}, {1,0,1,1,0,1,1,0,1,1,1,1,0,0,0,1}, {1,1,1,0,1,0,0,0,1,1,0,0,0,0,1,1}, {0,0,0,0,1,0,1,1,1,0,0,1,0,1,0,1}, {0,1,1,1,0,1,0,1,0,0,0,0,0,0,1,0}, {0,1,0,0,0,0,1,1,0,0,0,0,0,0,1,1}, {1,1,0,0,0,0,0,1,1,1,0,0,0,0,1,0}, {0,1,0,1,1,0,0,0,0,1,1,0,1,0,0,0}, {1,1,1,0,1,0,0,1,1,0,1,0,0,1,1,1}, {0,1,1,1,0,0,0,0,1,1,1,1,0,0,1,0}, {0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,1}, {0,0,1,1,0,0,1,1,1,1,0,1,1,1,1,0}, {1,0,0,0,1,1,1,0,1,1,0,0,0,1,1,0}, {0,1,0,0,1,1,0,0,1,1,0,0,0,1,1,1}, {1,0,1,0,1,0,1,1,0,0,0,1,1,0,0,0}, {1,1,0,0,0,1,1,0,0,0,0,1,1,1,0,0}, {1,0,0,0,1,0,1,0,1,1,1,0,1,0,1,0}, {1,1,1,0,0,0,1,0,1,1,0,0,0,0,1,0}, {1,0,0,1,0,1,0,1,0,0,1,0,0,0,1,1}, {0,0,1,1,0,0,1,0,0,1,1,1,0,0,0,1}, {1,0,1,0,0,1,1,1,0,0,1,1,0,0,0,0}, {0,1,1,0,1,0,0,1,1,1,0,0,1,0,0,1}, {1,0,0,0,1,1,1,1,1,1,0,1,0,0,0,1}, {1,0,0,1,0,1,1,0,0,0,1,0,0,1,1,1}, {0,0,0,0,1,0,1,1,0,1,1,1,0,1,0,0}, {0,1,0,0,0,1,0,0,0,0,1,1,1,1,1,0}, {0,1,1,0,1,1,0,0,1,1,0,1,1,0,1,0}, {0,1,0,1,0,1,0,1,1,0,0,0,1,0,0,0}, {0,1,0,0,1,1,0,0,0,1,1,1,0,0,1,0}, {1,1,1,0,0,0,0,1,1,1,0,1,1,0,1,1}, {1,0,0,0,1,1,1,0,1,1,0,1,0,1,0,0}, {1,1,0,0,1,1,0,1,1,0,1,0,0,0,1,1}, {0,1,1,1,0,0,1,0,0,1,0,1,1,1,0,1}, {0,1,1,0,0,0,1,1,0,1,1,1,0,1,0,0}, {0,0,1,1,1,0,1,0,1,1,0,0,1,1,0,0}, {0,0,0,1,1,1,0,1,1,1,1,1,0,0,0,0}, {1,1,0,0,1,0,0,0,0,0,1,1,1,1,1,1}, {0,1,1,1,0,1,1,1,0,0,1,0,0,0,1,0}, {0,0,0,1,1,1,1,1,0,0,1,1,0,1,1,1}, {0,0,0,1,1,0,1,0,1,1,0,0,1,1,1,1}, {0,1,1,0,0,0,0,0,1,0,1,1,0,0,0,0}, {1,0,1,1,1,1,0,1,1,0,1,1,1,0,0,1}, {1,1,0,0,1,1,0,0,0,1,1,0,1,0,0,0}, {0,1,1,1,1,0,0,0,1,0,1,1,0,0,1,0}, {1,1,0,1,0,1,1,1,0,0,0,1,1,1,1,1}, {0,0,1,0,1,0,1,0,1,1,1,0,1,1,0,1}, {1,0,1,0,0,1,1,1,1,0,1,0,1,0,0,0}, {0,1,0,1,0,1,0,1,0,1,0,0,1,1,0,0}, {0,1,0,0,0,1,1,0,0,0,1,0,0,0,0,1}, {0,1,0,1,0,0,1,1,1,1,1,1,0,1,1,1}, {1,0,1,1,1,1,0,1,0,1,1,0,0,1,0,0}, {0,1,1,0,0,0,1,0,0,1,1,1,1,0,0,1}, {0,1,0,1,0,1,0,1,1,1,1,0,1,0,0,1}, {1,1,0,0,1,0,0,0,0,0,1,0,1,0,0,0}, {0,0,1,1,0,1,1,0,0,1,0,0,1,0,0,1}, {0,0,0,1,1,0,0,1,0,1,1,1,1,0,0,0}, {1,1,0,0,1,1,0,0,1,1,1,1,1,1,1,1}, {0,1,1,0,0,0,0,0,1,0,1,0,1,0,0,0}, {1,1,1,0,1,1,0,0,1,1,0,1,0,1,1,0}, {0,0,1,1,1,0,0,0,0,1,0,0,1,0,0,1}, {0,0,1,0,0,1,1,0,1,0,0,0,0,0,1,1}, {1,0,0,1,1,1,1,0,1,0,1,0,1,0,0,1}};

int pOut[NUM_SAMPLE][NUM_OUT]
	 = {{0,0,0,0,1,0,1,1,1,1,1,0,0,0,0,1}, {1,1,0,0,0,0,1,0,1,1,0,0,0,0,0,0}, {0,0,1,0,1,0,1,0,0,1,1,1,1,1,1,0}, {1,0,1,0,1,0,1,1,1,1,0,1,1,0,1,1}, {0,1,0,1,0,0,1,1,1,0,0,1,0,1,1,1}, {0,1,0,1,0,1,0,1,1,0,1,0,0,0,1,0}, {0,1,0,1,0,1,1,0,0,0,1,0,1,1,1,1}, {1,0,1,0,0,1,0,0,0,0,1,1,1,1,1,1}, {0,0,1,1,0,0,1,1,1,0,1,1,1,0,0,1}, {1,1,0,1,0,0,0,0,0,0,1,1,1,0,1,0}, {1,1,1,1,0,0,0,0,1,0,1,1,1,0,1,1}, {1,0,0,0,0,0,0,0,0,1,1,0,0,0,1,0}, {0,1,0,0,0,1,0,1,0,1,1,0,1,0,0,1}, {0,0,0,0,0,0,0,1,1,0,0,0,1,1,1,0}, {0,0,1,1,1,1,1,0,1,0,0,1,1,1,1,0}, {0,1,0,1,1,0,0,0,0,0,0,1,1,0,1,1}, {1,1,0,1,0,1,1,0,0,1,1,1,0,1,0,0}, {0,1,1,1,1,1,1,0,1,1,1,0,1,1,1,0}, {1,1,0,0,1,0,0,0,0,1,1,1,0,0,1,1}, {1,0,0,0,0,0,1,1,1,0,0,1,1,1,1,1}, {0,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0}, {0,1,0,0,0,0,1,1,1,0,0,1,1,1,0,1}, {1,0,0,1,1,1,1,0,1,0,1,0,1,0,0,1}, {1,0,0,0,1,1,0,0,1,0,0,0,1,0,1,0}, {0,0,1,1,0,1,0,1,1,1,0,1,0,0,1,0}, {0,1,0,0,0,1,1,0,0,0,1,1,1,1,0,1}, {1,0,0,0,0,0,1,0,1,0,0,0,1,0,1,0}, {0,1,0,1,0,0,0,0,0,0,1,0,0,1,0,1}, {1,1,0,1,0,1,1,0,1,1,1,0,1,0,1,1}, {1,1,0,1,0,0,0,1,1,0,1,1,1,0,1,0}, {1,1,1,1,0,1,0,0,1,0,1,1,0,0,1,1}, {0,0,1,1,0,1,0,0,1,1,0,1,0,1,1,1}, {0,0,0,1,0,1,0,1,1,1,1,1,1,1,0,1}, {0,0,1,0,1,1,1,1,1,0,1,1,0,1,0,0}, {0,0,1,0,1,0,1,1,1,1,0,1,0,0,1,1}, {0,0,1,1,0,1,1,0,0,0,1,0,0,1,1,1}, {1,1,1,1,1,0,1,0,1,1,0,0,1,1,0,0}, {1,1,1,1,1,1,1,0,1,0,0,1,1,1,1,0}, {0,0,1,1,1,1,1,0,1,1,1,0,0,0,0,0}, {0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,0}, {1,1,1,0,1,0,0,0,0,0,1,1,0,1,0,0}, {1,1,0,1,1,0,1,0,1,0,1,1,1,1,0,0}, {0,0,1,0,0,0,1,0,0,0,1,1,0,0,1,0}, {1,1,1,0,0,0,0,0,1,0,0,1,1,0,1,1}, {1,0,0,0,0,1,0,0,1,1,0,0,0,0,1,1}, {1,1,1,0,0,1,0,1,1,0,1,1,0,0,0,0}, {0,0,1,1,1,1,1,1,1,1,0,1,0,1,1,1}, {0,1,0,1,0,1,0,1,0,1,0,1,0,0,0,1}, {0,0,0,0,0,0,0,1,0,1,1,1,1,1,1,0}, {0,1,0,1,1,1,0,1,1,0,0,1,0,0,0,1}, {0,1,0,0,0,0,0,1,0,0,1,0,1,1,1,1}, {1,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0}, {1,0,0,0,1,0,1,1,1,1,1,1,0,1,1,1}, {0,1,0,0,0,0,1,1,0,0,0,0,1,1,0,1}, {1,1,0,0,1,0,1,1,0,1,0,1,1,0,0,1}, {1,0,1,1,0,1,0,1,1,0,0,1,1,1,1,0}, {1,1,0,1,1,0,0,1,1,1,1,1,0,1,1,1}, {0,0,1,0,0,0,0,0,1,1,1,1,0,1,1,1}, {1,1,0,1,1,0,1,1,0,1,1,1,0,0,0,0}, {0,1,1,0,0,0,0,1,1,1,1,0,0,0,1,0}, {0,1,1,0,0,0,1,1,0,1,0,1,0,0,0,0}, {0,0,0,0,1,1,1,0,1,1,0,0,0,0,0,1}, {1,1,0,1,1,0,1,0,0,1,1,0,1,0,1,1}, {1,1,0,0,1,0,1,0,0,1,0,0,0,1,0,1}, {0,1,0,0,0,1,1,1,1,1,1,1,1,1,1,0}, {1,0,1,0,0,0,0,1,1,0,1,0,1,1,1,1}, {1,1,1,1,0,1,0,1,1,1,1,0,1,1,0,1}, {0,0,0,0,0,0,0,1,0,0,1,1,1,1,0,1}, {1,1,0,0,0,1,0,0,0,0,0,1,0,1,0,0}, {1,1,1,1,0,1,0,0,0,0,0,1,0,0,1,1}, {0,0,0,1,1,0,0,0,1,0,1,0,0,1,0,1}, {1,0,0,1,1,1,1,1,1,1,0,1,0,1,1,0}, {1,1,1,1,0,1,1,0,0,0,1,1,0,0,0,1}, {0,0,0,0,1,1,0,0,0,1,0,0,0,1,1,1}, {1,0,1,1,0,1,0,1,1,1,0,0,1,1,1,1}, {1,1,0,0,0,1,0,0,0,0,0,0,1,0,1,1}, {0,1,0,0,1,1,0,0,1,0,1,0,1,0,0,1}, {0,0,0,1,0,0,0,1,0,0,0,1,1,1,1,0}, {1,1,0,1,1,0,0,1,1,0,0,1,0,1,0,1}, {1,1,0,0,0,1,1,0,0,0,0,0,0,1,1,1}, {0,0,1,0,1,0,0,1,1,1,1,1,0,1,0,1}, {1,1,0,1,1,1,1,1,0,0,1,1,0,0,0,0}, {1,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0}, {0,1,1,0,0,1,0,0,1,1,0,0,0,0,0,1}, {1,1,1,1,1,1,1,0,0,0,1,0,1,0,0,1}, {1,0,1,1,1,1,0,1,0,0,0,1,1,1,0,1}, {1,1,0,1,1,1,0,0,1,0,0,0,1,1,0,0}, {0,0,0,0,0,1,0,0,0,0,1,1,1,0,0,0}, {1,0,0,0,1,1,0,1,0,0,1,0,0,0,0,1}, {0,1,1,0,0,0,1,1,0,0,0,0,0,1,1,1}, {1,1,0,0,1,0,0,0,1,0,0,1,1,1,0,1}, {1,1,1,1,0,1,1,1,1,0,0,1,0,0,1,0}, {1,0,0,1,0,1,1,1,0,0,1,0,0,1,1,1}, {0,1,0,0,1,1,1,0,0,1,1,1,1,0,1,1}, {1,0,0,0,1,0,1,1,1,1,0,0,0,1,1,0}, {1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1}, {0,1,1,0,0,0,0,0,0,0,1,1,1,1,0,0}, {1,1,0,1,0,1,1,1,0,0,0,0,0,0,1,1}, {0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,1}, {1,0,0,1,1,1,1,0,0,0,1,0,0,1,1,0}, {0,1,0,1,1,0,0,0,1,1,1,1,1,0,1,1}, {0,1,1,1,1,0,0,1,0,1,1,1,1,1,0,0}, {1,1,1,1,0,1,1,0,0,1,0,0,0,0,0,0}, {1,1,1,1,0,0,1,0,1,0,1,0,1,0,1,1}, {0,1,1,0,0,1,1,1,0,0,1,1,1,1,0,1}, {0,1,1,0,0,0,1,0,0,1,0,0,1,0,1,0}, {0,1,0,1,1,1,0,1,1,1,1,0,0,0,0,1}, {1,0,0,0,0,1,0,1,1,1,1,0,0,0,0,0}, {0,0,1,1,1,0,0,1,0,0,1,1,0,0,0,0}, {0,0,0,0,1,1,0,1,0,1,0,1,0,0,0,0}, {1,1,1,1,0,0,0,0,1,1,0,0,0,1,1,0}, {0,1,0,1,1,1,1,1,0,0,0,0,0,1,1,1}, {0,0,0,0,1,0,1,1,1,1,1,0,0,0,0,0}, {1,1,1,1,0,0,1,1,0,0,1,0,1,1,1,0}, {1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,1}, {0,1,0,0,0,1,0,0,0,1,1,0,0,0,0,0}, {0,1,1,1,1,1,0,0,0,0,0,0,0,1,1,0}, {0,0,1,1,0,0,0,0,0,0,0,0,1,0,1,0}, {1,0,0,0,0,0,0,1,0,1,1,0,0,1,0,0}, {0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0}, {0,0,0,1,1,0,1,1,0,0,0,0,0,1,0,0}, {1,1,1,1,0,1,1,0,0,1,1,1,1,1,0,1}, {1,1,1,0,1,0,0,0,0,1,1,0,1,0,0,0}, {1,0,0,1,1,1,0,0,0,1,0,1,0,0,0,0}, {1,0,1,1,0,0,1,1,0,1,1,1,0,1,1,1}, {0,1,1,1,0,0,1,1,1,0,0,0,0,0,0,1}, {1,1,1,1,0,0,0,0,0,1,1,0,0,0,1,1}, {0,0,0,1,1,0,0,1,0,0,0,1,0,1,1,0}};

float pL1[NUM_MID];
float pL2[NUM_OUT];
float y[NUM_MID];
float z[NUM_OUT];

float delta1[NUM_OUT];
float delta2[NUM_MID];

int printWeight();
double printNNOut();
int loadWeights();
int saveWeights();

float sigmoid(float x)
{
	return 1.0 / (1 + exp(-x));
}

float derivSigmoid(float x)
{
	return x * (1 - x);
}

float ReLU(float x)
{
	// Not differentiable at x = 0
	//return (x > 0)? (ReLU_TANGENT * x) : 0;

	// Differentiable at x = 0
	return log(1 + exp(x));
}

float derivReLU(float x)
{
	// return (x > 0)? ReLU_TANGENT : 0;

	return 1.0 / (1 + 1.0/exp(x));
}

int printWeight(int flag1, int flag2)
{
	int i, j, k;

	if(flag1)
	{
		printf("[weights 1]");
		for(i=0; i<NUM_IN; i++)
		{
			printf("\t");

			for(j=0; j<NUM_MID; j++)
				printf("%5.2f ", weightL1[i][j]);

			printf("\n");
		}
	}

	printf("\n");

	if(flag2)
	{
		printf("[weights 2]");
		for(j=0; j<NUM_MID; j++)
		{
			printf("\t");

			for(k=0; k<NUM_OUT; k++)
				printf("%5.2f ", weightL2[j][k]);

			printf("\n");
		
		}
	}

	printf("\n");

	return 0;
}

double printNNOut(int flag)
{
	double diff;
	double sum = 0;

	for(int train=0; train<NUM_SAMPLE; train++)
	{
		for(int j=0; j<NUM_MID; j++)
		{
			pL1[j] = 0;

			for(int i=0; i<NUM_IN; i++)
				pL1[j] += x[train][i] * weightL1[i][j];

			y[j] = ReLU(pL1[j]);
		}

		for(int k=0; k<NUM_OUT; k++)
		{
			pL2[k] = 0;

			for(int j=0; j<NUM_MID; j++)
				pL2[k] += y[j] * weightL2[j][k];

			z[k] = ReLU(pL2[k]);
		}

		// Print Result
		if(flag)
			printf("[Net]");

		int iteration = (NUM_OUT > NUM_IN)? NUM_OUT : NUM_IN;

		for(int k=0; k<iteration; k++)
		{
			if(flag)
			{
				if(k < NUM_IN)
					printf("\t%5d", x[train][k]);
				else
					printf("\t     ");

				printf("  -->  ");

				if(k < NUM_OUT)
					printf("%4.2f (%d)\n", z[k], pOut[train][k]);
				else
					printf("\n");
			}

			if(k < NUM_OUT)
			{
				diff = pOut[train][k] - z[k];
				sum += diff * diff;
			}
		}

		if(flag)
			printf("\n");
	}

	return sum;
}

int initialiseWeight()
{
	float temp;

	for(int i=0; i<NUM_IN; i++)
	{
		for(int j=0; j<NUM_MID; j++)
		{
			temp = rand() % 200 + 1;	// 1 - 200
			temp /= 100;			// 0.01 - 2.00
			temp -= 1;				// -1 - 1

			weightL1[i][j] = temp;
		}
	}

	for(int j=0; j<NUM_MID; j++)
	{
		for(int k=0; k<NUM_OUT; k++)
		{
			temp = rand() % 200 + 1;
			temp /= 100;
			temp -= 1;

			weightL2[j][k] = temp;
		}
	}

	return 0;
}

int main()
{
	int round, train;
	int i, j, k;
	int err = 3;

	srand(1010);

	initialiseWeight();
	//err = loadWeights();

	switch(err)
	{
		case 3: printf("[system] Weights initialised\n\n");	break;
		case 1: printf("[error] File tree not found\n\n");	break;
		case 2: printf("[error] Incorrect net size\n\n");	break;
		case 0: printf("[system] Loading weight info\n\n");	break;
	}

	//settings
	int iteration = 100000;
	int info = 1;

	double totalDiff;

	if(info)
	{
		printWeight(1, 1);
		printNNOut(1);
	}

	float runtime = 0.0;
	runtime = clock();

	for(round=0; round < iteration/NUM_SAMPLE + 1; round++)
	{
		if(info == 2)
			printf("%4d/%d\n", round+1, iteration/NUM_SAMPLE);

		for(train=0; train<NUM_SAMPLE; train++)
		{
			if(info == 2)
				printf("	%4d/%d\n", train+1, NUM_SAMPLE);

			// Feed Forward //
			for(j=0; j<NUM_MID; j++)
			{
				pL1[j] = 0.0;

				for(i=0; i<NUM_IN; i++)
					pL1[j] += x[train][i] * weightL1[i][j];

				y[j] = ReLU(pL1[j]);
			}

			for(k=0; k<NUM_OUT; k++)
			{
				pL2[k] = 0.0;

				for(j=0; j<NUM_MID; j++)
					pL2[k] += y[j] * weightL2[j][k];

				z[k] = ReLU(pL2[k]);
			}

			// Back Prop //
			for(k=0; k<NUM_OUT; k++)
			{
				delta1[k] = (pOut[train][k]-z[k]) * derivReLU(z[k]);

				for(j=0; j<NUM_MID; j++)
				{
					weightL2[j][k] += delta1[k] * y[j];

					delta2[j] = delta1[k] * weightL2[j][k] * derivReLU(y[j]);

					for(i=0; i<NUM_IN; i++)
					{
						weightL1[i][j] += delta2[j] * x[train][i];
					}
				}
			}
		}

		if(info == 2)
			printf("\n");
	}

	runtime = clock() - runtime;
	runtime /= CLOCKS_PER_SEC;

	// debug
	if(info)
		printWeight(1, 1);

	totalDiff = printNNOut(info);

	// halt
	saveWeights();

	totalDiff /= (NUM_SAMPLE * NUM_OUT);

	printf("total difference: %4.4f\n", totalDiff);
	printf("execution time: %.3f s\n\n", runtime);

	return 0;
}

const char *location = "./neuralWeightReLU.txt";

int loadWeights()
{
	int input, middle, output, set;

	FILE *fpRead = fopen(location, "rt");

	if(fpRead == NULL)
		return 1;

	fscanf(fpRead, "%d %d %d %d\n", &input, &middle, &output, &set);

	if(input!=NUM_IN || middle!=NUM_MID || output!=NUM_OUT || set!=NUM_SAMPLE)
		return 2;

	for(int i=0; i<NUM_IN; i++)
		for(int j=0; j<NUM_MID; j++)
			fscanf(fpRead, "%f\n", &weightL1[i][j]);


	for(int j=0; j<NUM_MID; j++)
		for(int k=0; k<NUM_OUT; k++)
			fscanf(fpRead, "%f\n", &weightL2[j][k]);

	return 0;
}

int saveWeights()
{
	FILE *fpWrite = fopen(location, "wt");

	if(fpWrite == NULL)
		return 1;

	fprintf(fpWrite, "%d %d %d %d\n", NUM_IN, NUM_MID, NUM_OUT, NUM_SAMPLE);

	for(int i=0; i<NUM_IN; i++)
		for(int j=0; j<NUM_MID; j++)
			fprintf(fpWrite, "%10.4f\n", weightL1[i][j]);

	for(int j=0; j<NUM_MID; j++)
		for(int k=0; k<NUM_OUT; k++)
			fprintf(fpWrite, "%10.4f\n", weightL2[j][k]);

	return 0;
}
